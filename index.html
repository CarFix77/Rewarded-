<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AdRewards PRO</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0c1a12;
      color: white;
      text-align: center;
      padding: 20px;
    }
    .card {
      background: #1a2e22;
      border-radius: 10px;
      padding: 20px;
      margin: 20px auto;
      max-width: 500px;
    }
    .btn {
      background: #2d7d46;
      color: white;
      border: none;
      padding: 15px 20px;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 15px;
      display: inline-block;
      text-decoration: none;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div id="app-content" class="hidden">
    <div class="card">
      <h2>Добро пожаловать!</h2>
      <p>Ваш ID: <strong id="user-id"></strong></p>
      <p>Статус: <span id="status">Авторизован в Telegram</span></p>
    </div>
  </div>

  <div id="auth-message">
    <div class="card">
      <h2>Требуется авторизация</h2>
      <p id="status-text">Проверяем платформу...</p>
      <a href="https://t.me/Ad_Rew_ards_bot?startapp=rewards" class="btn" id="tg-btn">Открыть в Telegram</a>
      <p style="margin-top: 20px; color: #8fa89a;">
        Если вы уже в Telegram, попробуйте:<br>
        1. Обновить страницу<br>
        2. Перезапустить бота<br>
        3. Очистить кэш браузера
      </p>
    </div>
  </div>

  <script>
    // 1. Улучшенная проверка Telegram WebApp
    function isInTelegramWebApp() {
      // Основные признаки WebApp
      const isWebApp = !!window.Telegram?.WebApp?.platform;
      
      // Дополнительные проверки
      const hasInitData = !!window.Telegram?.WebApp?.initData;
      const hasStartParam = !!window.Telegram?.WebApp?.startParam;
      
      // Проверка по user-agent (дополнительно)
      const isTelegramBrowser = navigator.userAgent.includes('TelegramWebApp');
      
      return isWebApp || hasInitData || hasStartParam || isTelegramBrowser;
    }

    // 2. Получение User ID
    function getTelegramUserId() {
      try {
        const tgWebApp = window.Telegram?.WebApp;
        if (!tgWebApp) return null;
        
        // Основной способ
        if (tgWebApp.initDataUnsafe?.user?.id) {
          return tgWebApp.initDataUnsafe.user.id.toString();
        }
        
        // Альтернативный способ через initData
        if (tgWebApp.initData) {
          const params = new URLSearchParams(tgWebApp.initData);
          const userStr = params.get('user');
          if (userStr) {
            const user = JSON.parse(userStr);
            return user?.id?.toString();
          }
        }
        
        return null;
      } catch (e) {
        console.error('Ошибка при получении ID:', e);
        return null;
      }
    }

    // 3. Инициализация приложения
    function initApp() {
      const isTelegram = isInTelegramWebApp();
      const userId = isTelegram ? getTelegramUserId() : null;
      
      if (isTelegram && userId) {
        // Успешная авторизация
        document.getElementById('app-content').classList.remove('hidden');
        document.getElementById('auth-message').classList.add('hidden');
        document.getElementById('user-id').textContent = userId;
        
        // Здесь можно загружать данные пользователя
        console.log('User ID:', userId);
        
      } else {
        // Показываем сообщение об авторизации
        document.getElementById('auth-message').classList.remove('hidden');
        document.getElementById('status-text').textContent = isTelegram 
          ? "Не удалось получить ID пользователя" 
          : "Приложение работает только в Telegram";
      }
    }

    // 4. Запуск с несколькими проверками
    function startApp() {
      // Первая проверка (немедленно)
      initApp();
      
      // Повторная проверка через 1 секунду (на случай медленной инициализации WebApp)
      setTimeout(initApp, 1000);
      
      // Финальная проверка через 3 секунды
      setTimeout(() => {
        if (document.getElementById('auth-message').classList.contains('hidden')) return;
        initApp();
        console.log('Финальная проверка статуса');
      }, 3000);
    }

    // 5. Запуск приложения
    document.addEventListener('DOMContentLoaded', startApp);

    // 6. Отладочная информация
    console.log('Telegram WebApp:', window.Telegram?.WebApp);
    console.log('User:', window.Telegram?.WebApp?.initDataUnsafe?.user);
    console.log('Platform:', window.Telegram?.WebApp?.platform);
    console.log('UserAgent:', navigator.userAgent);
  </script>
</body>
</html>
